# Reusable build workflow for Hugo + HugoBlox
name: Build Hugo Site

on:
  workflow_call:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Read Hugo version from hugoblox.yaml
        id: hugo-version
        run: |
          HUGO_VERSION=$(grep 'hugo_version' hugoblox.yaml | sed "s/.*hugo_version: *['\"]\\(.*\\)['\"].*/\\1/")
          echo "version=${HUGO_VERSION}" >> "$GITHUB_OUTPUT"

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Hugo Extended
        run: |
          wget -O ${{ runner.temp }}/hugo.deb https://github.com/gohugoio/hugo/releases/download/v${{ steps.hugo-version.outputs.version }}/hugo_extended_${{ steps.hugo-version.outputs.version }}_linux-amd64.deb \
          && sudo dpkg -i ${{ runner.temp }}/hugo.deb

      - name: Setup Pages
        id: pages
        uses: actions/configure-pages@v5

      - name: Install Hugo module dependencies
        run: hugo mod get

      - name: Install Node dependencies
        run: npm ci

      - name: Build with Hugo
        env:
          HUGO_CACHEDIR: ${{ runner.temp }}/hugo_cache
          HUGO_ENVIRONMENT: production
          TZ: America/Los_Angeles
        run: |
          hugo \
            --gc \
            --minify \
            --baseURL "${{ steps.pages.outputs.base_url }}/"

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./public
